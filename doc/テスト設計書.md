# Chrome拡張機能「Markdown Viewer with Mermaid」テスト設計書

## 1. テスト戦略

### 1.1 テストレベル
- **単体テスト (Unit Test)**: 個別のクラス・関数のテスト
- **統合テスト (Integration Test)**: モジュール間の連携テスト
- **E2Eテスト (End-to-End Test)**: ユーザーシナリオのテスト
- **パフォーマンステスト**: 負荷・速度テスト
- **アクセシビリティテスト**: WCAG準拠テスト

### 1.2 テスト環境
- **ブラウザ**: Chrome 90+, Edge 90+, Firefox 90+
- **OS**: Windows 10/11, macOS 10.15+, Ubuntu 20.04+
- **テストフレームワーク**: Jest, Puppeteer, WebDriver
- **CI/CD**: GitHub Actions

### 1.3 テストデータ
```
test-data/
├── markdown/
│   ├── basic.md              # 基本的なMarkdown
│   ├── complex.md            # 複雑な構造のMarkdown
│   ├── mermaid-diagrams.md   # Mermaid図を含むファイル
│   ├── large-document.md     # 大きなファイル (>1MB)
│   ├── japanese.md           # 日本語コンテンツ
│   ├── code-heavy.md         # コードブロック多数
│   └── malformed.md          # 不正な形式
├── images/
│   ├── test-image.png
│   └── large-image.jpg
└── exports/
    ├── expected-output.pdf
    └── expected-output.html
```

## 2. 単体テスト設計

### 2.1 TOCGenerator テスト
```javascript
/**
 * TOCGenerator 単体テスト
 */
describe('TOCGenerator', () => {
  let tocGenerator;
  let mockContainer;
  
  beforeEach(() => {
    // DOM環境のセットアップ
    document.body.innerHTML = `
      <div id="markdown-content">
        <h1 id="heading-1">Introduction</h1>
        <h2 id="heading-1-1">Overview</h2>
        <h2 id="heading-1-2">Features</h2>
        <h3 id="heading-1-2-1">Core Features</h3>
        <h1 id="heading-2">Installation</h1>
      </div>
    `;
    
    tocGenerator = new TOCGenerator({
      maxDepth: 6,
      minDepth: 1,
      includeNumbers: true
    });
  });
  
  afterEach(() => {
    if (tocGenerator) {
      tocGenerator.destroy();
    }
    document.body.innerHTML = '';
  });
  
  describe('extractHeadings', () => {
    test('should extract all headings correctly', () => {
      tocGenerator.extractHeadings();
      
      expect(tocGenerator.headings).toHaveLength(5);
      expect(tocGenerator.headings[0].text).toBe('Introduction');
      expect(tocGenerator.headings[0].level).toBe(1);
      expect(tocGenerator.headings[1].text).toBe('Overview');
      expect(tocGenerator.headings[1].level).toBe(2);
    });
    
    test('should respect maxDepth option', () => {
      tocGenerator.options.maxDepth = 2;
      tocGenerator.extractHeadings();
      
      const h3Headings = tocGenerator.headings.filter(h => h.level === 3);
      expect(h3Headings).toHaveLength(0);
    });
    
    test('should generate IDs for headings without IDs', () => {
      document.body.innerHTML = `
        <div id="markdown-content">
          <h1>No ID Heading</h1>
        </div>
      `;
      
      tocGenerator.extractHeadings();
      
      expect(tocGenerator.headings[0].id).toBeDefined();
      expect(tocGenerator.headings[0].element.id).toBeDefined();
    });
  });
  
  describe('buildHierarchy', () => {
    test('should build correct parent-child relationships', () => {
      tocGenerator.extractHeadings();
      
      const h1Headings = tocGenerator.headings.filter(h => h.level === 1);
      const h2Headings = tocGenerator.headings.filter(h => h.level === 2);
      
      expect(h1Headings[0].children).toHaveLength(2);
      expect(h2Headings[0].parent).toBe(h1Headings[0]);
      expect(h2Headings[1].parent).toBe(h1Headings[0]);
    });
  });
  
  describe('generateTOCHTML', () => {
    test('should generate valid HTML structure', () => {
      tocGenerator.extractHeadings();
      const html = tocGenerator.generateTOCHTML();
      
      expect(html).toContain('<ul class="toc-list">');
      expect(html).toContain('<li class="toc-item"');
      expect(html).toContain('<a href="#heading-1"');
      expect(html).toContain('Introduction');
    });
    
    test('should include numbers when enabled', () => {
      tocGenerator.options.includeNumbers = true;
      tocGenerator.extractHeadings();
      const html = tocGenerator.generateTOCHTML();
      
      expect(html).toContain('<span class="toc-number">');
    });
    
    test('should not include numbers when disabled', () => {
      tocGenerator.options.includeNumbers = false;
      tocGenerator.extractHeadings();
      const html = tocGenerator.generateTOCHTML();
      
      expect(html).not.toContain('<span class="toc-number">');
    });
  });
  
  describe('scrollToHeading', () => {
    test('should scroll to correct position', () => {
      const mockScrollTo = jest.fn();
      window.scrollTo = mockScrollTo;
      
      tocGenerator.scrollToHeading('heading-1');
      
      expect(mockScrollTo).toHaveBeenCalled();
    });
    
    test('should handle non-existent heading gracefully', () => {
      const mockScrollTo = jest.fn();
      window.scrollTo = mockScrollTo;
      
      tocGenerator.scrollToHeading('non-existent');
      
      expect(mockScrollTo).not.toHaveBeenCalled();
    });
  });
  
  describe('setActiveHeading', () => {
    test('should update active heading correctly', () => {
      tocGenerator.init();
      
      tocGenerator.setActiveHeading('heading-1');
      
      const activeLink = document.querySelector('.toc-link.active');
      expect(activeLink).toBeTruthy();
      expect(activeLink.dataset.headingId).toBe('heading-1');
    });
  });
});
```

### 2.2 ThemeManager テスト
```javascript
/**
 * ThemeManager 単体テスト
 */
describe('ThemeManager', () => {
  let themeManager;
  let mockStorage;
  
  beforeEach(() => {
    // Chrome Storage API のモック
    mockStorage = {
      sync: {
        get: jest.fn().mockResolvedValue({}),
        set: jest.fn().mockResolvedValue(),
        remove: jest.fn().mockResolvedValue()
      }
    };
    global.chrome = { storage: mockStorage };
    
    themeManager = new ThemeManager();
  });
  
  afterEach(() => {
    if (themeManager) {
      themeManager.destroy();
    }
  });
  
  describe('registerTheme', () => {
    test('should register theme correctly', () => {
      const themeConfig = {
        name: 'Test Theme',
        variables: {
          '--bg-color': '#ffffff',
          '--text-color': '#000000'
        }
      };
      
      themeManager.registerTheme('test', themeConfig);
      
      expect(themeManager.themes.has('test')).toBe(true);
      expect(themeManager.themes.get('test').name).toBe('Test Theme');
    });
  });
  
  describe('applyTheme', () => {
    test('should apply CSS variables correctly', async () => {
      const themeConfig = {
        variables: {
          '--bg-color': '#ffffff',
          '--text-color': '#000000'
        }
      };
      
      themeManager.registerTheme('test', themeConfig);
      await themeManager.applyTheme('test');
      
      const root = document.documentElement;
      expect(root.style.getPropertyValue('--bg-color')).toBe('#ffffff');
      expect(root.style.getPropertyValue('--text-color')).toBe('#000000');
    });
    
    test('should set data-theme attribute', async () => {
      themeManager.registerTheme('test', { variables: {} });
      await themeManager.applyTheme('test');
      
      expect(document.documentElement.getAttribute('data-theme')).toBe('test');
    });
    
    test('should handle auto theme correctly', async () => {
      // システムテーマをダークに設定
      Object.defineProperty(window, 'matchMedia', {
        writable: true,
        value: jest.fn().mockImplementation(query => ({
          matches: query === '(prefers-color-scheme: dark)',
          media: query,
          onchange: null,
          addListener: jest.fn(),
          removeListener: jest.fn(),
          addEventListener: jest.fn(),
          removeEventListener: jest.fn(),
          dispatchEvent: jest.fn(),
        })),
      });
      
      await themeManager.applyTheme('auto');
      
      expect(document.documentElement.getAttribute('data-theme')).toBe('dark');
    });
  });
  
  describe('detectSystemTheme', () => {
    test('should detect dark theme correctly', () => {
      Object.defineProperty(window, 'matchMedia', {
        writable: true,
        value: jest.fn().mockImplementation(() => ({
          matches: true
        })),
      });
      
      themeManager.setupSystemThemeDetection();
      const theme = themeManager.detectSystemTheme();
      
      expect(theme).toBe('dark');
    });
    
    test('should detect light theme correctly', () => {
      Object.defineProperty(window, 'matchMedia', {
        writable: true,
        value: jest.fn().mockImplementation(() => ({
          matches: false
        })),
      });
      
      themeManager.setupSystemThemeDetection();
      const theme = themeManager.detectSystemTheme();
      
      expect(theme).toBe('light');
    });
  });
});
```

### 2.3 SearchEngine テスト
```javascript
/**
 * SearchEngine 単体テスト
 */
describe('SearchEngine', () => {
  let searchEngine;
  let container;
  
  beforeEach(() => {
    container = document.createElement('div');
    container.innerHTML = `
      <h1>Introduction</h1>
      <p>This is a test document with some content.</p>
      <h2>Features</h2>
      <p>The search engine can find text in documents.</p>
      <code>const test = "example";</code>
    `;
    document.body.appendChild(container);
    
    searchEngine = new SearchEngine(container);
  });
  
  afterEach(() => {
    document.body.removeChild(container);
  });
  
  describe('buildIndex', () => {
    test('should build search index correctly', () => {
      expect(searchEngine.searchIndex.size).toBeGreaterThan(0);
      expect(searchEngine.searchIndex.has('introduction')).toBe(true);
      expect(searchEngine.searchIndex.has('test')).toBe(true);
    });
  });
  
  describe('search', () => {
    test('should find exact matches', () => {
      const results = searchEngine.search('introduction');
      
      expect(results.length).toBeGreaterThan(0);
      expect(results[0].text.toLowerCase()).toContain('introduction');
    });
    
    test('should be case insensitive by default', () => {
      const results = searchEngine.search('INTRODUCTION');
      
      expect(results.length).toBeGreaterThan(0);
    });
    
    test('should respect case sensitive option', () => {
      const results = searchEngine.search('INTRODUCTION', { caseSensitive: true });
      
      expect(results.length).toBe(0);
    });
    
    test('should support regex search', () => {
      const results = searchEngine.search('test.*document', { regexEnabled: true });
      
      expect(results.length).toBeGreaterThan(0);
    });
    
    test('should handle invalid regex gracefully', () => {
      const results = searchEngine.search('[invalid', { regexEnabled: true });
      
      expect(results.length).toBe(0);
    });
  });
  
  describe('highlightResults', () => {
    test('should highlight search results', () => {
      const results = searchEngine.search('test');
      searchEngine.highlightResults(results);
      
      const highlights = container.querySelectorAll('.search-highlight');
      expect(highlights.length).toBeGreaterThan(0);
    });
    
    test('should clear previous highlights', () => {
      searchEngine.search('test');
      searchEngine.highlightResults([]);
      
      const highlights = container.querySelectorAll('.search-highlight');
      expect(highlights.length).toBe(0);
    });
  });
});
```

## 3. 統合テスト設計

### 3.1 コンポーネント間連携テスト
```javascript
/**
 * コンポーネント統合テスト
 */
describe('Component Integration', () => {
  let app;
  
  beforeEach(async () => {
    // テスト用のMarkdownコンテンツを設定
    document.body.innerHTML = `
      <div id="markdown-content">
        <h1>Test Document</h1>
        <p>This is a test document.</p>
        <h2>Section 1</h2>
        <p>Content of section 1.</p>
      </div>
    `;
    
    app = new MarkdownViewerApp();
    await app.init();
  });
  
  afterEach(() => {
    if (app) {
      app.cleanup();
    }
  });
  
  describe('TOC and Theme Integration', () => {
    test('should update TOC colors when theme changes', async () => {
      const themeManager = app.components.get('themeManager');
      const tocPanel = app.components.get('tocPanel');
      
      // ダークテーマに変更
      await themeManager.applyTheme('dark');
      
      // TOCの色が更新されることを確認
      const tocElement = document.querySelector('.toc-panel');
      const computedStyle = window.getComputedStyle(tocElement);
      
      expect(computedStyle.backgroundColor).not.toBe('rgb(255, 255, 255)');
    });
  });
  
  describe('Search and TOC Integration', () => {
    test('should navigate to TOC item when search result is clicked', async () => {
      const searchEngine = app.components.get('searchEngine');
      const tocGenerator = app.components.get('tocGenerator');
      
      // 見出しを検索
      const results = searchEngine.search('Section 1');
      expect(results.length).toBeGreaterThan(0);
      
      // 検索結果をクリック（シミュレート）
      const mockScrollTo = jest.fn();
      window.scrollTo = mockScrollTo;
      
      tocGenerator.scrollToHeading('section-1');
      
      expect(mockScrollTo).toHaveBeenCalled();
    });
  });
  
  describe('Theme and Mermaid Integration', () => {
    test('should update Mermaid theme when app theme changes', async () => {
      // Mermaid図を含むコンテンツを追加
      const mermaidDiv = document.createElement('div');
      mermaidDiv.className = 'mermaid';
      mermaidDiv.textContent = 'graph TD\n  A --> B';
      document.getElementById('markdown-content').appendChild(mermaidDiv);
      
      const themeManager = app.components.get('themeManager');
      const mermaidEngine = app.components.get('mermaidEngine');
      
      // テーマ変更
      await themeManager.applyTheme('dark');
      
      // Mermaidテーマも変更されることを確認
      expect(mermaidEngine.currentTheme).toBe('dark');
    });
  });
});
```

### 3.2 ストレージ統合テスト
```javascript
/**
 * ストレージ統合テスト
 */
describe('Storage Integration', () => {
  let storageManager;
  let mockChrome;
  
  beforeEach(() => {
    // Chrome API のモック
    mockChrome = {
      storage: {
        sync: {
          get: jest.fn(),
          set: jest.fn(),
          remove: jest.fn(),
          clear: jest.fn()
        }
      }
    };
    global.chrome = mockChrome;
    
    storageManager = new StorageManager();
  });
  
  describe('Settings Persistence', () => {
    test('should save and load theme settings', async () => {
      const themeSettings = {
        theme: {
          current: 'dark',
          autoDetect: false
        }
      };
      
      mockChrome.storage.sync.set.mockResolvedValue();
      mockChrome.storage.sync.get.mockResolvedValue(themeSettings);
      
      await storageManager.set(themeSettings);
      const loaded = await storageManager.get('theme');
      
      expect(loaded.current).toBe('dark');
      expect(loaded.autoDetect).toBe(false);
    });
    
    test('should merge with defaults for partial settings', async () => {
      const partialSettings = {
        theme: {
          current: 'dark'
          // autoDetect is missing
        }
      };
      
      mockChrome.storage.sync.get.mockResolvedValue(partialSettings);
      
      const loaded = await storageManager.get('theme');
      
      expect(loaded.current).toBe('dark');
      expect(loaded.autoDetect).toBe(true); // default value
    });
  });
  
  describe('Settings Validation', () => {
    test('should validate and correct invalid settings', async () => {
      const invalidSettings = {
        theme: {
          current: 'invalid-theme',
          fontSize: 'invalid-size'
        }
      };
      
      const validated = storageManager.validateSettings(invalidSettings);
      
      expect(validated.theme.current).toBe('light'); // corrected to default
    });
  });
});
```

## 4. E2Eテスト設計

### 4.1 Puppeteer E2Eテスト
```javascript
/**
 * E2E テスト (Puppeteer)
 */
describe('E2E Tests', () => {
  let browser;
  let page;
  let extensionId;
  
  beforeAll(async () => {
    // Chrome拡張機能付きでブラウザを起動
    browser = await puppeteer.launch({
      headless: false,
      args: [
        '--load-extension=./dist',
        '--disable-extensions-except=./dist',
        '--disable-web-security'
      ]
    });
    
    page = await browser.newPage();
    
    // 拡張機能IDを取得
    const targets = await browser.targets();
    const extensionTarget = targets.find(target => 
      target.type() === 'background_page' && target.url().includes('chrome-extension://')
    );
    extensionId = extensionTarget.url().split('/')[2];
  });
  
  afterAll(async () => {
    await browser.close();
  });
  
  describe('Basic Functionality', () => {
    test('should render markdown file correctly', async () => {
      // テスト用Markdownファイルを開く
      await page.goto(`file://${__dirname}/test-data/markdown/basic.md`);
      
      // レンダリング完了を待機
      await page.waitForSelector('#markdown-content', { timeout: 5000 });
      
      // 見出しが正しくレンダリングされているか確認
      const h1 = await page.$eval('h1', el => el.textContent);
      expect(h1).toBe('Test Document');
      
      // 段落が正しくレンダリングされているか確認
      const p = await page.$eval('p', el => el.textContent);
      expect(p).toContain('This is a test document');
    });
    
    test('should render Mermaid diagrams', async () => {
      await page.goto(`file://${__dirname}/test-data/markdown/mermaid-diagrams.md`);
      
      // Mermaid図のレンダリング完了を待機
      await page.waitForSelector('.mermaid svg', { timeout: 10000 });
      
      // SVGが生成されているか確認
      const svgCount = await page.$$eval('.mermaid svg', svgs => svgs.length);
      expect(svgCount).toBeGreaterThan(0);
    });
  });
  
  describe('TOC Functionality', () => {
    test('should generate and display TOC', async () => {
      await page.goto(`file://${__dirname}/test-data/markdown/complex.md`);
      
      // TOCパネルの表示を待機
      await page.waitForSelector('.toc-panel', { timeout: 5000 });
      
      // TOCリンクが生成されているか確認
      const tocLinks = await page.$$eval('.toc-link', links => 
        links.map(link => link.textContent.trim())
      );
      
      expect(tocLinks.length).toBeGreaterThan(0);
      expect(tocLinks[0]).toContain('Introduction');
    });
    
    test('should navigate when TOC link is clicked', async () => {
      await page.goto(`file://${__dirname}/test-data/markdown/complex.md`);
      await page.waitForSelector('.toc-panel');
      
      // 最初のTOCリンクをクリック
      await page.click('.toc-link[data-heading-id="introduction"]');
      
      // スクロール位置が変更されることを確認
      await page.waitForTimeout(1000); // スムーススクロール完了を待機
      
      const scrollTop = await page.evaluate(() => window.pageYOffset);
      expect(scrollTop).toBeGreaterThan(0);
    });
  });
  
  describe('Theme Functionality', () => {
    test('should switch themes correctly', async () => {
      await page.goto(`file://${__dirname}/test-data/markdown/basic.md`);
      await page.waitForSelector('#markdown-content');
      
      // テーマセレクターを開く
      await page.click('.theme-selector-button');
      await page.waitForSelector('.theme-dropdown');
      
      // ダークテーマを選択
      await page.click('.theme-option[data-theme="dark"]');
      
      // data-theme属性が変更されることを確認
      const theme = await page.$eval('html', el => el.getAttribute('data-theme'));
      expect(theme).toBe('dark');
      
      // 背景色が変更されることを確認
      const bgColor = await page.$eval('body', el => 
        window.getComputedStyle(el).backgroundColor
      );
      expect(bgColor).not.toBe('rgb(255, 255, 255)');
    });
  });
  
  describe('Search Functionality', () => {
    test('should search and highlight results', async () => {
      await page.goto(`file://${__dirname}/test-data/markdown/basic.md`);
      await page.waitForSelector('#markdown-content');
      
      // 検索パネルを開く
      await page.keyboard.press('Control+KeyF');
      await page.waitForSelector('.search-panel');
      
      // 検索実行
      await page.type('.search-input', 'test');
      await page.keyboard.press('Enter');
      
      // 検索結果がハイライトされることを確認
      await page.waitForSelector('.search-highlight');
      const highlights = await page.$$('.search-highlight');
      expect(highlights.length).toBeGreaterThan(0);
    });
  });
  
  describe('Export Functionality', () => {
    test('should export to PDF', async () => {
      await page.goto(`file://${__dirname}/test-data/markdown/basic.md`);
      await page.waitForSelector('#markdown-content');
      
      // エクスポートボタンをクリック
      await page.click('.export-button');
      await page.waitForSelector('.export-dropdown');
      
      // PDF出力を選択
      await page.click('.export-pdf-button');
      
      // ダウンロード完了を待機（実際の実装では適切な待機処理が必要）
      await page.waitForTimeout(3000);
      
      // ダウンロードが開始されたことを確認（実装依存）
      // この部分は実際のダウンロード処理に応じて調整が必要
    });
  });
});
```

### 4.2 ユーザーシナリオテスト
```javascript
/**
 * ユーザーシナリオテスト
 */
describe('User Scenarios', () => {
  let browser;
  let page;
  
  beforeAll(async () => {
    browser = await puppeteer.launch({
      headless: false,
      args: ['--load-extension=./dist']
    });
    page = await browser.newPage();
  });
  
  afterAll(async () => {
    await browser.close();
  });
  
  describe('Developer Documentation Review Scenario', () => {
    test('should support typical developer workflow', async () => {
      // 1. 技術文書を開く
      await page.goto(`file://${__dirname}/test-data/markdown/api-documentation.md`);
      await page.waitForSelector('#markdown-content');
      
      // 2. 目次で構造を把握
      await page.waitForSelector('.toc-panel');
      const tocItems = await page.$$eval('.toc-link', links => links.length);
      expect(tocItems).toBeGreaterThan(5);
      
      // 3. 特定のAPIを検索
      await page.keyboard.press('Control+KeyF');
      await page.type('.search-input', 'POST /api/users');
      await page.keyboard.press('Enter');
      
      // 4. 検索結果に移動
      await page.waitForSelector('.search-highlight');
      
      // 5. ダークテーマに切り替え（夜間作業）
      await page.click('.theme-selector-button');
      await page.click('.theme-option[data-theme="dark"]');
      
      // 6. PDFでエクスポート（共有用）
      await page.click('.export-button');
      await page.click('.export-pdf-button');
      
      // 各ステップが正常に動作することを確認
      const theme = await page.$eval('html', el => el.getAttribute('data-theme'));
      expect(theme).toBe('dark');
    });
  });
  
  describe('Project Manager Review Scenario', () => {
    test('should support project documentation review', async () => {
      // 1. プロジェクト仕様書を開く
      await page.goto(`file://${__dirname}/test-data/markdown/project-spec.md`);
      await page.waitForSelector('#markdown-content');
      
      // 2. 進捗状況の図表を確認
      await page.waitForSelector('.mermaid svg');
      
      // 3. 重要なセクションをブックマーク（将来の機能）
      // await page.click('.bookmark-button');
      
      // 4. コメントを追加（将来の機能）
      // await page.click('.comment-button');
      
      // 5. チーム共有用にHTMLエクスポート
      await page.click('.export-button');
      await page.click('.export-html-button');
      
      // 基本的な表示が正常に動作することを確認
      const mermaidSvgs = await page.$$('.mermaid svg');
      expect(mermaidSvgs.length).toBeGreaterThan(0);
    });
  });
});
```

## 5. パフォーマンステスト設計

### 5.1 負荷テスト
```javascript
/**
 * パフォーマンステスト
 */
describe('Performance Tests', () => {
  let browser;
  let page;
  
  beforeAll(async () => {
    browser = await puppeteer.launch({
      args: ['--load-extension=./dist']
    });
    page = await browser.newPage();
  });
  
  afterAll(async () => {
    await browser.close();
  });
  
  describe('Large Document Performance', () => {
    test('should handle large markdown files efficiently', async () => {
      const startTime = Date.now();
      
      // 大きなMarkdownファイル（1MB+）を開く
      await page.goto(`file://${__dirname}/test-data/markdown/large-document.md`);
      await page.waitForSelector('#markdown-content');
      
      const loadTime = Date.now() - startTime;
      
      // 5秒以内に読み込み完了
      expect(loadTime).toBeLessThan(5000);
      
      // メモリ使用量をチェック
      const metrics = await page.metrics();
      expect(metrics.JSHeapUsedSize).toBeLessThan(50 * 1024 * 1024); // 50MB未満
    });
    
    test('should generate TOC for large documents quickly', async () => {
      await page.goto(`file://${__dirname}/test-data/markdown/large-document.md`);
      await page.waitForSelector('#markdown-content');
      
      const startTime = Date.now();
      
      // TOC生成完了を待機
      await page.waitForSelector('.toc-panel .toc-link');
      
      const tocGenerationTime = Date.now() - startTime;
      
      // 2秒以内にTOC生成完了
      expect(tocGenerationTime).toBeLessThan(2000);
    });
  });
  
  describe('Multiple Mermaid Diagrams Performance', () => {
    test('should render multiple diagrams efficiently', async () => {
      const startTime = Date.now();
      
      // 複数のMermaid図を含むファイルを開く
      await page.goto(`file://${__dirname}/test-data/markdown/multiple-mermaid.md`);
      
      // すべてのMermaid図のレンダリング完了を待機
      await page.waitForFunction(() => {
        const mermaidElements = document.querySelectorAll('.mermaid');
        const svgElements = document.querySelectorAll('.mermaid svg');
        return mermaidElements.length === svgElements.length && svgElements.length > 10;
      }, { timeout: 30000 });
      
      const renderTime = Date.now() - startTime;
      
      // 30秒以内にすべての図がレンダリング完了
      expect(renderTime).toBeLessThan(30000);
    });
  });
  
  describe('Search Performance', () => {
    test('should search large documents quickly', async () => {
      await page.goto(`file://${__dirname}/test-data/markdown/large-document.md`);
      await page.waitForSelector('#markdown-content');
      
      // 検索パネルを開く
      await page.keyboard.press('Control+KeyF');
      await page.waitForSelector('.search-panel');
      
      const startTime = Date.now();
      
      // 検索実行
      await page.type('.search-input', 'function');
      
      // 検索結果表示完了を待機
      await page.waitForSelector('.search-results .search-result');
      
      const searchTime = Date.now() - startTime;
      
      // 1秒以内に検索完了
      expect(searchTime).toBeLessThan(1000);
    });
  });
});
```

### 5.2 メモリリークテスト
```javascript
/**
 * メモリリークテスト
 */
describe('Memory Leak Tests', () => {
  let browser;
  let page;
  
  beforeAll(async () => {
    browser = await puppeteer.launch({
      args: ['--load-extension=./dist']
    });
    page = await browser.newPage();
  });
  
  afterAll(async () => {
    await browser.close();
  });
  
  test('should not leak memory when switching themes repeatedly', async () => {
    await page.goto(`file://${__dirname}/test-data/markdown/basic.md`);
    await page.waitForSelector('#markdown-content');
    
    const initialMetrics = await page.metrics();
    const initialMemory = initialMetrics.JSHeapUsedSize;
    
    // テーマを100回切り替え
    for (let i = 0; i < 100; i++) {
      await page.click('.theme-selector-button');
      await page.click('.theme-option[data-theme="dark"]');
      await page.waitForTimeout(10);
      
      await page.click('.theme-selector-button');
      await page.click('.theme-option[data-theme="light"]');
      await page.waitForTimeout(10);
    }
    
    // ガベージコレクションを強制実行
    await page.evaluate(() => {
      if (window.gc) {
        window.gc();
      }
    });
    
    const finalMetrics = await page.metrics();
    const finalMemory = finalMetrics.JSHeapUsedSize;
    
    // メモリ使用量が初期値の2倍を超えていないことを確認
    expect(finalMemory).toBeLessThan(initialMemory * 2);
  });
  
  test('should cleanup event listeners properly', async () => {
    await page.goto(`file://${__dirname}/test-data/markdown/basic.md`);
    await page.waitForSelector('#markdown-content');
    
    // イベントリスナー数を取得（実装依存）
    const initialListeners = await page.evaluate(() => {
      return window.getEventListeners ? 
        Object.keys(window.getEventListeners(document)).length : 0;
    });
    
    // コンポーネントを複数回初期化・破棄
    for (let i = 0; i < 10; i++) {
      await page.evaluate(() => {
        if (window.markdownViewerApp) {
          window.markdownViewerApp.cleanup();
          window.markdownViewerApp.init();
        }
      });
    }
    
    const finalListeners = await page.evaluate(() => {
      return window.getEventListeners ? 
        Object.keys(window.getEventListeners(document)).length : 0;
    });
    
    // イベントリスナーが大幅に増加していないことを確認
    expect(finalListeners).toBeLessThan(initialListeners * 2);
  });
});
```

## 6. アクセシビリティテスト設計

### 6.1 WCAG準拠テスト
```javascript
/**
 * アクセシビリティテスト
 */
describe('Accessibility Tests', () => {
  let browser;
  let page;
  
  beforeAll(async () => {
    browser = await puppeteer.launch({
      args: ['--load-extension=./dist']
    });
    page = await browser.newPage();
  });
  
  afterAll(async () => {
    await browser.close();
  });
  
  describe('Keyboard Navigation', () => {
    test('should support keyboard navigation for TOC', async () => {
      await page.goto(`file://${__dirname}/test-data/markdown/basic.md`);
      await page.waitForSelector('.toc-panel');
      
      // TOCの最初のリンクにフォーカス
      await page.focus('.toc-link:first-child');
      
      // Tabキーで次のリンクに移動
      await page.keyboard.press('Tab');
      
      // フォーカスが移動していることを確認
      const focusedElement = await page.evaluate(() => document.activeElement.className);
      expect(focusedElement).toContain('toc-link');
    });
    
    test('should support keyboard shortcuts', async () => {
      await page.goto(`file://${__dirname}/test-data/markdown/basic.md`);
      await page.waitForSelector('#markdown-content');
      
      // Ctrl+F で検索パネルが開くことを確認
      await page.keyboard.press('Control+KeyF');
      await page.waitForSelector('.search-panel');
      
      const searchPanel = await page.$('.search-panel');
      expect(searchPanel).toBeTruthy();
    });
  });
  
  describe('ARIA Attributes', () => {
    test('should have proper ARIA labels', async () => {
      await page.goto(`file://${__dirname}/test-data/markdown/basic.md`);
      await page.waitForSelector('.toc-panel');
      
      // TOCナビゲーションにaria-labelがあることを確認
      const tocNav = await page.$eval('.toc-nav', el => el.getAttribute('aria-label'));
      expect(tocNav).toBe('目次');
      
      // 展開ボタンにaria-expandedがあることを確認
      const expandButton = await page.$eval('.toc-expand', el => el.getAttribute('aria-expanded'));
      expect(expandButton).toBeDefined();
    });
  });
  
  describe('Color Contrast', () => {
    test('should meet WCAG AA color contrast requirements', async () => {
      await page.goto(`file://${__dirname}/test-data/markdown/basic.md`);
      await page.waitForSelector('#markdown-content');
      
      // テキストと背景のコントラスト比を計算
      const contrastRatio = await page.evaluate(() => {
        const element = document.querySelector('p');
        const styles = window.getComputedStyle(element);
        const textColor = styles.color;
        const backgroundColor = styles.backgroundColor;
        
        // コントラスト比計算（簡略版）
        // 実際の実装では適切なコントラスト比計算ライブラリを使用
        return 4.5; // 仮の値
      });
      
      // WCAG AA基準（4.5:1）を満たすことを確認
      expect(contrastRatio).toBeGreaterThanOrEqual(4.5);
    });
  });
});
```

## 7. テスト実行・CI/CD設定

### 7.1 Jest設定
```javascript
// jest.config.js
module.exports = {
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/test/setup.js'],
  collectCoverageFrom: [
    'src/**/*.js',
    '!src/**/*.test.js',
    '!src/lib/**'
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  },
  testMatch: [
    '<rootDir>/test/unit/**/*.test.js',
    '<rootDir>/test/integration/**/*.test.js'
  ],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1'
  }
};
```

### 7.2 GitHub Actions設定
```yaml
# .github/workflows/test.yml
name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run unit tests
      run: npm run test:unit
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3

  e2e-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build extension
      run: npm run build
    
    - name: Run E2E tests
      run: npm run test:e2e
    
    - name: Upload test artifacts
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: e2e-screenshots
        path: test/screenshots/

  performance-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build extension
      run: npm run build
    
    - name: Run performance tests
      run: npm run test:performance
    
    - name: Upload performance report
      uses: actions/upload-artifact@v3
      with:
        name: performance-report
        path: test/performance-report.html
```

### 7.3 テスト実行スクリプト
```json
{
  "scripts": {
    "test": "npm run test:unit && npm run test:integration",
    "test:unit": "jest --config jest.config.js test/unit",
    "test:integration": "jest --config jest.config.js test/integration",
    "test:e2e": "jest --config jest.e2e.config.js test/e2e",
    "test:performance": "jest --config jest.performance.config.js test/performance",
    "test:accessibility": "jest --config jest.a11y.config.js test/accessibility",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:ci": "jest --ci --coverage --watchAll=false"
  }
}
```

---

**作成日**: 2025年1月28日  
**バージョン**: 1.0  
**作成者**: Kiro AI Assistant