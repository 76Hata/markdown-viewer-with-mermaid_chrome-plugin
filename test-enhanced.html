<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Markdown Viewer Test</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div id="container">
        <div id="markdown-content"></div>
    </div>
    
    <script src="lib/marked.min.js"></script>
    <script src="lib/mermaid.min.js"></script>
    <script src="js/toc-generator.js"></script>
    <script src="js/theme-manager.js"></script>
    <script src="js/search-engine.js"></script>
    <script src="js/toolbar.js"></script>
    
    <script>
        const testMarkdown = `# Enhanced Markdown Viewer Test 🚀

このテストファイルは新しく実装された機能をテストするためのものです。

## 🎯 実装された機能

### 1. 目次自動生成
- ✅ 階層構造の自動認識
- ✅ クリックでセクションジャンプ
- ✅ 現在位置のハイライト
- ✅ 折りたたみ機能

### 2. テーマシステム
- ✅ ライトテーマ
- ✅ ダークテーマ  
- ✅ セピアテーマ
- ✅ 自動テーマ切り替え

### 3. 検索機能
- ✅ リアルタイム検索
- ✅ 正規表現サポート
- ✅ 大文字小文字区別
- ✅ 結果ハイライト

## 📊 Mermaidダイアグラムテスト

### フローチャート
\`\`\`mermaid
graph TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Process A]
    B -->|No| D[Process B]
    C --> E[End]
    D --> E
\`\`\`

### シーケンス図
\`\`\`mermaid
sequenceDiagram
    participant User
    participant Extension
    participant Markdown
    participant Mermaid
    
    User->>Extension: Open .md file
    Extension->>Markdown: Parse content
    Markdown-->>Extension: HTML output
    Extension->>Mermaid: Render diagrams
    Mermaid-->>Extension: SVG output
    Extension->>User: Display result
\`\`\`

### クラス図
\`\`\`mermaid
classDiagram
    class ThemeManager {
        +themes: Map
        +currentTheme: string
        +applyTheme()
        +registerTheme()
    }
    
    class TOCGenerator {
        +headings: Array
        +options: Object
        +extractHeadings()
        +renderTOC()
    }
    
    class SearchEngine {
        +searchIndex: Map
        +currentResults: Array
        +search()
        +navigateResults()
    }
    
    class Toolbar {
        +themeManager: ThemeManager
        +tocGenerator: TOCGenerator
        +searchEngine: SearchEngine
        +init()
    }
    
    Toolbar --> ThemeManager
    Toolbar --> TOCGenerator
    Toolbar --> SearchEngine
\`\`\`

## 📝 コードブロックテスト

### JavaScript
\`\`\`javascript
class MarkdownViewer {
    constructor(options) {
        this.options = options;
        this.init();
    }
    
    init() {
        console.log('Initializing enhanced viewer...');
        this.setupComponents();
    }
    
    setupComponents() {
        this.toolbar = new Toolbar();
        this.themeManager = new ThemeManager();
        this.tocGenerator = new TOCGenerator();
        this.searchEngine = new SearchEngine();
    }
}
\`\`\`

### Python
\`\`\`python
def test_markdown_features():
    """Test all implemented features"""
    features = [
        'toc_generation',
        'theme_switching', 
        'search_functionality',
        'mermaid_rendering'
    ]
    
    for feature in features:
        result = test_feature(feature)
        print(f"{feature}: {'✅ PASS' if result else '❌ FAIL'}")
\`\`\`

### CSS
\`\`\`css
/* Enhanced theming system */
:root {
    --primary-color: #0969da;
    --bg-color: #ffffff;
    --text-color: #24292e;
}

[data-theme="dark"] {
    --bg-color: #0d1117;
    --text-color: #e6edf3;
}
\`\`\`

## 📋 テーブルテスト

| 機能 | 状態 | 詳細 | 備考 |
|------|------|------|------|
| TOC Generator | ✅ 完了 | 階層構造対応 | スムーススクロール |
| Theme Manager | ✅ 完了 | 3テーマ + 自動 | CSS変数使用 |
| Search Engine | ✅ 完了 | 正規表現対応 | リアルタイム |
| Toolbar | ✅ 完了 | 統合UI | レスポンシブ |
| Print Support | ✅ 完了 | CSS最適化 | メディアクエリ |

## 🎨 スタイリングテスト

### 引用文
> **重要な機能**  
> この拡張機能は、従来の基本的なMarkdownビューアーから、
> 開発者向けの高機能ツールへと進化しました。

### リスト
1. **Phase 1実装項目**
   - 目次自動生成
   - テーマシステム
   - 検索機能
   - ツールバー統合

2. **今後の拡張予定**
   - [ ] Markdown編集機能
   - [ ] ファイル保存機能
   - [ ] PDF出力
   - [ ] プラグインシステム

### 強調とリンク
- **太字テキスト**
- *斜体テキスト*
- \`インラインコード\`
- ~~取り消し線~~
- [リンクテスト](https://github.com)

## 🧪 テスト項目チェックリスト

### 基本機能
- [x] Markdownパース
- [x] Mermaid描画
- [x] レスポンシブデザイン
- [x] エラーハンドリング

### 拡張機能  
- [x] TOC生成・表示
- [x] テーマ切り替え
- [x] 検索パネル
- [x] ツールバー
- [x] 設定モーダル
- [x] 印刷最適化

### 操作性
- [x] キーボードショートカット
- [x] スムーススクロール
- [x] 折りたたみ機能
- [x] アクセシビリティ

## 📈 パフォーマンステスト

### レンダリング速度
- Markdown解析: < 100ms
- Mermaid描画: < 500ms  
- TOC生成: < 50ms
- テーマ切り替え: < 200ms

### メモリ使用量
- 基本表示: ~5MB
- 全機能有効: ~15MB
- 大型文書: ~25MB

---

**テスト完了** ✨  
すべての機能が正常に動作することを確認してください。
`;

        // Initialize mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose'
        });

        // Custom renderer for markdown
        const renderer = new marked.Renderer();
        let mermaidCounter = 0;

        renderer.code = function(code, language) {
            if (language === 'mermaid') {
                const id = `mermaid-${mermaidCounter++}`;
                return `<div class="mermaid" id="${id}" data-mermaid-code="${encodeURIComponent(code)}">${code}</div>`;
            }
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            return `<pre><code class="language-${language || ''}">${escapeHtml(code)}</code></pre>`;
        };

        marked.setOptions({
            renderer: renderer,
            gfm: true,
            breaks: false
        });

        // Render mermaid diagrams
        async function renderMermaidDiagrams() {
            const mermaidElements = document.querySelectorAll('.mermaid');
            console.log(`Found ${mermaidElements.length} mermaid elements`);
            
            for (const element of mermaidElements) {
                try {
                    const graphDefinition = element.textContent.trim();
                    const { svg } = await mermaid.render(`graph-${element.id}`, graphDefinition);
                    element.innerHTML = svg;
                    console.log('Mermaid rendered successfully');
                } catch (error) {
                    console.error('Mermaid error:', error);
                    element.innerHTML = `<pre style="color: red;">Mermaid error: ${error.message}</pre>`;
                }
            }
        }

        // Main initialization
        async function init() {
            try {
                console.log('Starting enhanced markdown test...');
                
                // Render markdown
                const html = marked.parse(testMarkdown);
                document.getElementById('markdown-content').innerHTML = html;
                
                // Render mermaid diagrams
                await renderMermaidDiagrams();
                
                // Store original content
                document.body.dataset.originalMarkdown = testMarkdown;
                
                // Initialize enhanced features
                setTimeout(() => {
                    try {
                        window.markdownViewerToolbar = new Toolbar();
                        console.log('✅ All enhanced features initialized successfully');
                        
                        // Show success message
                        const successMsg = document.createElement('div');
                        successMsg.style.cssText = `
                            position: fixed;
                            top: 60px;
                            right: 20px;
                            background: #28a745;
                            color: white;
                            padding: 15px;
                            border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            z-index: 9999;
                            font-weight: bold;
                        `;
                        successMsg.textContent = '✨ Enhanced features loaded successfully!';
                        document.body.appendChild(successMsg);
                        
                        setTimeout(() => successMsg.remove(), 3000);
                        
                    } catch (error) {
                        console.error('❌ Error initializing enhanced features:', error);
                    }
                }, 500);
                
            } catch (error) {
                console.error('❌ Test initialization error:', error);
                document.getElementById('markdown-content').innerHTML = 
                    `<h1>❌ Test Error</h1><pre style="color: red;">${error.message}</pre>`;
            }
        }

        // Start test when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>