<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Markdown Viewer - Standalone</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div id="container">
        <div id="markdown-content"></div>
    </div>
    
    <!-- 基本ライブラリ -->
    <script src="lib/marked.min.js"></script>
    <script src="lib/mermaid.min.js"></script>
    
    <!-- 拡張機能 -->
    <script src="js/toc-generator.js"></script>
    <script src="js/theme-manager.js"></script>
    <script src="js/search-engine.js"></script>
    <script src="js/toolbar.js"></script>
    
    <script>
        // サンプルMarkdownコンテンツ
        const sampleMarkdown = `# Enhanced Markdown Viewer Demo 🚀

このデモでは、実装された全ての機能をテストできます。

## 🎯 実装機能

### 1. 目次自動生成
左側に表示される目次から各セクションにジャンプできます。

### 2. テーマシステム
ツールバーのテーマボタンから以下のテーマを選択できます：
- **Light**: 明るいテーマ
- **Dark**: 暗いテーマ  
- **Sepia**: セピア調テーマ
- **Auto**: システム設定に連動

### 3. 検索機能
\`Ctrl+F\` または検索ボタンで高機能検索が利用できます：
- リアルタイム検索
- 正規表現サポート
- ハイライト表示

## 📊 Mermaidダイアグラムテスト

### フローチャート
\`\`\`mermaid
graph TD
    A[ユーザー] --> B{機能選択}
    B -->|目次| C[TOC表示]
    B -->|検索| D[検索パネル]
    B -->|テーマ| E[テーマ切り替え]
    C --> F[スムーススクロール]
    D --> G[ハイライト表示]
    E --> H[CSS変数更新]
\`\`\`

### シーケンス図
\`\`\`mermaid
sequenceDiagram
    participant U as ユーザー
    participant T as ツールバー
    participant TM as テーママネージャー
    participant TOC as 目次生成器
    
    U->>T: ボタンクリック
    T->>TM: テーマ変更要求
    TM->>TM: CSS変数更新
    TM->>TOC: 再描画通知
    TOC->>U: UI更新完了
\`\`\`

## 📝 コードブロック

### JavaScript
\`\`\`javascript
// ツールバー初期化例
const toolbar = new Toolbar(document.body);
console.log('Enhanced features loaded!');
\`\`\`

### CSS
\`\`\`css
/* テーマ変数例 */
:root {
    --bg-color: #ffffff;
    --text-color: #24292e;
}

[data-theme="dark"] {
    --bg-color: #0d1117;
    --text-color: #e6edf3;
}
\`\`\`

## 📋 機能テストチェックリスト

- [ ] ツールバーが表示される
- [ ] 目次が生成され、クリックでジャンプできる
- [ ] テーマ切り替えが動作する
- [ ] 検索機能が使える
- [ ] Mermaid図が正しく表示される
- [ ] レスポンシブデザインが動作する

## 🎮 操作方法

### キーボードショートカット
- \`Ctrl+F\`: 検索パネル表示
- \`Ctrl+T\`: 目次表示切り替え
- \`Ctrl+P\`: 印刷
- \`Escape\`: パネルを閉じる

### ツールバーボタン
- **📋**: 目次表示/非表示
- **🔍**: 検索パネル表示
- **🎨**: テーマ選択
- **🖨️**: 印刷
- **⚙️**: 設定

---

**すべての機能が正常に動作していれば、Enhanced Markdown Viewer は完璧に実装されています！** ✨
`;

        // 初期化処理
        async function initializeStandaloneViewer() {
            try {
                console.log('Standalone viewer initialization started...');
                
                // Mermaid初期化
                if (typeof mermaid !== 'undefined') {
                    mermaid.initialize({
                        startOnLoad: false,
                        theme: 'default',
                        securityLevel: 'loose'
                    });
                }
                
                // Markdownレンダリング
                if (typeof marked !== 'undefined') {
                    const renderer = new marked.Renderer();
                    let mermaidCounter = 0;
                    
                    renderer.code = function(code, language) {
                        if (language === 'mermaid') {
                            const id = `mermaid-${mermaidCounter++}`;
                            return `<div class="mermaid" id="${id}" data-mermaid-code="${encodeURIComponent(code)}">${code}</div>`;
                        }
                        const escapeHtml = (text) => {
                            const div = document.createElement('div');
                            div.textContent = text;
                            return div.innerHTML;
                        };
                        return `<pre><code class="language-${language || ''}">${escapeHtml(code)}</code></pre>`;
                    };
                    
                    marked.setOptions({
                        renderer: renderer,
                        gfm: true,
                        breaks: false
                    });
                    
                    // HTMLに変換
                    const html = marked.parse(sampleMarkdown);
                    document.getElementById('markdown-content').innerHTML = html;
                    
                    // Mermaid図を描画
                    await renderMermaidDiagrams();
                    
                    // 元のコンテンツを保存
                    document.body.dataset.originalMarkdown = sampleMarkdown;
                    
                    // ツールバー初期化
                    setTimeout(() => {
                        if (typeof Toolbar !== 'undefined') {
                            window.markdownViewerToolbar = new Toolbar(document.body);
                            console.log('✅ Standalone viewer initialized successfully!');
                            
                            // 成功メッセージ表示
                            showSuccessMessage();
                        } else {
                            console.error('❌ Toolbar class not available');
                        }
                    }, 500);
                    
                } else {
                    console.error('❌ Marked.js not available');
                }
                
            } catch (error) {
                console.error('❌ Initialization error:', error);
            }
        }
        
        // Mermaid図の描画
        async function renderMermaidDiagrams() {
            if (typeof mermaid === 'undefined') return;
            
            const mermaidElements = document.querySelectorAll('.mermaid');
            console.log(`Found ${mermaidElements.length} mermaid elements`);
            
            for (let i = 0; i < mermaidElements.length; i++) {
                const element = mermaidElements[i];
                try {
                    const graphDefinition = element.textContent.trim();
                    const { svg } = await mermaid.render(`graph-${i}`, graphDefinition);
                    element.innerHTML = svg;
                    console.log(`✅ Mermaid diagram ${i + 1} rendered`);
                } catch (error) {
                    console.error(`❌ Mermaid diagram ${i + 1} error:`, error);
                    element.innerHTML = `<pre style="color: red;">Mermaid error: ${error.message}</pre>`;
                }
            }
        }
        
        // 成功メッセージ表示
        function showSuccessMessage() {
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 9999;
                font-weight: bold;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            message.innerHTML = `
                ✨ Enhanced Markdown Viewer 完全動作中！<br>
                <small>全ての機能をお試しください</small>
            `;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.opacity = '0';
                message.style.transition = 'opacity 0.5s';
                setTimeout(() => message.remove(), 500);
            }, 4000);
        }
        
        // ページ読み込み完了後に初期化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeStandaloneViewer);
        } else {
            initializeStandaloneViewer();
        }
    </script>
</body>
</html>